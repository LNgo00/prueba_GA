apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  annotations:
    kubernetes.io/ingress.class: nginx
    nginx.ingress.kubernetes.io/use-regex: "true"
    nginx.ingress.kubernetes.io/rewrite-target: /$2
  name: cb-ingress-corporate
spec:
  rules:
  - host: {{ .Values.platform_hostname }}
    http:
      paths:
      - backend:
          service:
            name: cb-corporate
            port:
              number: 8080
        path: /company(/|$)(.*)
        pathType: Prefix
      - backend:
          service:
            name: cb-corporate
            port:
              number: 8080
        path: /()(contact)
        pathType: Prefix
  tls: # < placing a host in the TLS config will determine what ends up in the cert's subjectAltNames
  - hosts:
    - {{ .Values.platform_hostname }}
    - www.{{ .Values.platform_hostname }}
    secretName: cb-ingress-cert-platform


  # - "traefik.get.frontend.rule=Host:${DOMAIN_NAME};PathPrefixStrip:/company;Method:GET" # Use WEB_PATH (somehow)
  # - "traefik.post.frontend.rule=Host:${DOMAIN_NAME};Method:POST;Path:/subscribe,/es/subscribe,/contact,/es/contact"
  # - "traefik.frontend.headers.frameDeny=true"
  # - "traefik.frontend.rateLimit.extractorFunc=client.ip"
  
  # https://stackoverflow.com/questions/40009640/how-do-i-set-up-a-kubernetes-ingress-rule-with-a-regex-path
  # https://github.com/kubernetes/ingress-nginx/blob/main/docs/examples/rewrite/README.md
  # - "traefik.frontend.redirect.regex=^https://${DOMAIN_NAME}/company/es$$"
  # - "traefik.frontend.redirect.replacement=https://${DOMAIN_NAME}/company/es/"